{% extends "base.html" %}

{% block title %}CDS Hooks Tester - FHIR Server{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="md:flex md:items-center md:justify-between">
        <div class="min-w-0 flex-1">
            <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:truncate sm:text-3xl sm:tracking-tight">
                CDS Hooks Tester
            </h1>
            <p class="mt-1 text-sm text-gray-500">
                Discover and test Clinical Decision Support services
            </p>
        </div>
        <div class="mt-4 md:mt-0">
            <button onclick="discoverServices()" id="discover-btn"
                    class="inline-flex items-center rounded-md bg-fhir-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-fhir-700">
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                </svg>
                Refresh Services
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Panel: Services List -->
        <div class="space-y-4">
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">Available Services</h2>
                </div>
                <div id="services-list" class="divide-y divide-gray-200">
                    <div class="p-4 text-center text-gray-500">
                        <svg class="mx-auto h-8 w-8 animate-spin text-fhir-600" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <p class="mt-2 text-sm">Loading services...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Middle Panel: Request Builder -->
        <div class="space-y-4">
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-200">
                    <h2 class="text-lg font-medium text-gray-900">Request</h2>
                </div>
                <div id="request-builder" class="p-4">
                    <div id="no-service-selected" class="text-center text-gray-500 py-8">
                        <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p class="mt-2 text-sm">Select a service to build a request</p>
                    </div>
                    <div id="request-form" class="hidden space-y-4">
                        <!-- Hook Context -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Hook</label>
                            <input type="text" id="hook-type" readonly
                                   class="w-full text-sm border-gray-300 rounded-md bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Patient ID</label>
                            <select id="request-patient" class="w-full text-sm border-gray-300 rounded-md">
                                <option value="">-- Select Patient --</option>
                            </select>
                        </div>
                        <div id="encounter-field" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Encounter ID</label>
                            <input type="text" id="request-encounter" placeholder="Optional"
                                   class="w-full text-sm border-gray-300 rounded-md">
                        </div>
                        <div id="user-field">
                            <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                            <input type="text" id="request-user" placeholder="Practitioner/123"
                                   class="w-full text-sm border-gray-300 rounded-md">
                        </div>

                        <!-- Prefetch Toggle -->
                        <div class="border-t border-gray-200 pt-4">
                            <label class="flex items-center text-sm">
                                <input type="checkbox" id="include-prefetch" checked class="mr-2 rounded border-gray-300">
                                <span class="font-medium text-gray-700">Include prefetch data</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">Let the server fetch required data</p>
                        </div>

                        <!-- Execute Button -->
                        <div class="pt-2">
                            <button onclick="invokeService()" id="invoke-btn"
                                    class="w-full inline-flex justify-center items-center rounded-md bg-fhir-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-fhir-700">
                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                                </svg>
                                Invoke Service
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Raw Request/Response -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-200">
                    <div class="flex space-x-4">
                        <button onclick="showTab('request')" id="tab-request"
                                class="text-sm font-medium text-fhir-600 border-b-2 border-fhir-600 pb-1">Request JSON</button>
                        <button onclick="showTab('response')" id="tab-response"
                                class="text-sm font-medium text-gray-500 hover:text-gray-700 pb-1">Response JSON</button>
                    </div>
                </div>
                <div id="raw-request" class="h-48 overflow-auto">
                    <pre id="request-json" class="p-4 text-xs json-content">Select a service and fill in the form</pre>
                </div>
                <div id="raw-response" class="h-48 overflow-auto hidden">
                    <pre id="response-json" class="p-4 text-xs json-content">No response yet</pre>
                </div>
            </div>
        </div>

        <!-- Right Panel: Response Cards -->
        <div class="space-y-4">
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-lg font-medium text-gray-900">Response Cards</h2>
                    <span id="response-time" class="text-xs text-gray-500"></span>
                </div>
                <div id="cards-panel" class="p-4 space-y-4 max-h-[600px] overflow-auto">
                    <div id="cards-placeholder" class="text-center text-gray-500 py-8">
                        <svg class="mx-auto h-12 w-12" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                        </svg>
                        <p class="mt-2 text-sm">Invoke a service to see response cards</p>
                    </div>
                    <div id="cards-content" class="hidden space-y-4"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    var services = [];
    var selectedService = null;
    var patients = [];
    var lastResponse = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        discoverServices();
        loadPatients();
    });

    async function discoverServices() {
        var listDiv = document.getElementById('services-list');
        listDiv.innerHTML = `
            <div class="p-4 text-center text-gray-500">
                <svg class="mx-auto h-8 w-8 animate-spin text-fhir-600" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p class="mt-2 text-sm">Loading services...</p>
            </div>
        `;

        try {
            var response = await fetch('/cds-services');
            if (response.ok) {
                var data = await response.json();
                services = data.services || [];
                renderServices();
            } else {
                listDiv.innerHTML = '<div class="p-4 text-center text-red-500 text-sm">Failed to load services</div>';
            }
        } catch (e) {
            listDiv.innerHTML = '<div class="p-4 text-center text-red-500 text-sm">Error: ' + e.message + '</div>';
        }
    }

    function renderServices() {
        var listDiv = document.getElementById('services-list');

        if (services.length === 0) {
            listDiv.innerHTML = '<div class="p-4 text-center text-gray-500 text-sm">No services available</div>';
            return;
        }

        var html = '';
        services.forEach(function(service, index) {
            var hookBadge = getHookBadgeColor(service.hook);
            html += `
                <div class="p-4 hover:bg-gray-50 cursor-pointer ${selectedService === service ? 'bg-fhir-50 border-l-4 border-fhir-600' : ''}"
                     onclick="selectService(${index})">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-sm font-medium text-gray-900">${service.title || service.id}</h3>
                            <p class="text-xs text-gray-500 mt-1">${service.description || 'No description'}</p>
                        </div>
                        <span class="inline-flex items-center rounded-full px-2 py-1 text-xs font-medium ${hookBadge}">
                            ${service.hook}
                        </span>
                    </div>
                </div>
            `;
        });
        listDiv.innerHTML = html;
    }

    function getHookBadgeColor(hook) {
        switch (hook) {
            case 'patient-view': return 'bg-blue-100 text-blue-700';
            case 'order-select': return 'bg-green-100 text-green-700';
            case 'order-sign': return 'bg-purple-100 text-purple-700';
            case 'encounter-start': return 'bg-yellow-100 text-yellow-700';
            case 'encounter-discharge': return 'bg-orange-100 text-orange-700';
            default: return 'bg-gray-100 text-gray-700';
        }
    }

    async function loadPatients() {
        try {
            var response = await fetch('{{ api_base_path }}/Patient?_count=50');
            if (response.ok) {
                var bundle = await response.json();
                var select = document.getElementById('request-patient');
                (bundle.entry || []).forEach(function(entry) {
                    var patient = entry.resource;
                    patients.push(patient);
                    var name = 'Unknown';
                    if (patient.name && patient.name[0]) {
                        var n = patient.name[0];
                        name = (n.given || []).join(' ') + ' ' + (n.family || '');
                    }
                    var option = document.createElement('option');
                    option.value = patient.id;
                    option.textContent = name.trim() + ' (' + patient.id + ')';
                    select.appendChild(option);
                });
            }
        } catch (e) {
            console.error('Failed to load patients:', e);
        }
    }

    function selectService(index) {
        selectedService = services[index];
        renderServices();

        document.getElementById('no-service-selected').classList.add('hidden');
        document.getElementById('request-form').classList.remove('hidden');

        document.getElementById('hook-type').value = selectedService.hook;

        // Show/hide fields based on hook type
        var showEncounter = ['encounter-start', 'encounter-discharge', 'order-select', 'order-sign'].includes(selectedService.hook);
        document.getElementById('encounter-field').classList.toggle('hidden', !showEncounter);

        updateRequestPreview();
    }

    function updateRequestPreview() {
        if (!selectedService) return;

        var patientId = document.getElementById('request-patient').value || 'patient-123';
        var userId = document.getElementById('request-user').value || 'Practitioner/example';
        var encounterId = document.getElementById('request-encounter').value;

        var request = {
            hookInstance: crypto.randomUUID ? crypto.randomUUID() : 'hook-' + Date.now(),
            hook: selectedService.hook,
            context: {
                userId: userId,
                patientId: patientId
            }
        };

        if (encounterId) {
            request.context.encounterId = encounterId;
        }

        if (document.getElementById('include-prefetch').checked && selectedService.prefetch) {
            request.prefetch = {};
            // Note: actual prefetch will be done server-side
        }

        document.getElementById('request-json').textContent = JSON.stringify(request, null, 2);
        document.getElementById('request-json').innerHTML = highlightJSON(JSON.stringify(request, null, 2));
    }

    // Update preview when form changes
    document.getElementById('request-patient').addEventListener('change', updateRequestPreview);
    document.getElementById('request-user').addEventListener('input', updateRequestPreview);
    document.getElementById('request-encounter').addEventListener('input', updateRequestPreview);
    document.getElementById('include-prefetch').addEventListener('change', updateRequestPreview);

    async function invokeService() {
        if (!selectedService) return;

        var patientId = document.getElementById('request-patient').value;
        if (!patientId) {
            alert('Please select a patient');
            return;
        }

        var userId = document.getElementById('request-user').value || 'Practitioner/example';
        var encounterId = document.getElementById('request-encounter').value;

        var request = {
            hookInstance: crypto.randomUUID ? crypto.randomUUID() : 'hook-' + Date.now(),
            hook: selectedService.hook,
            context: {
                userId: userId,
                patientId: patientId
            }
        };

        if (encounterId) {
            request.context.encounterId = encounterId;
        }

        // Show loading
        document.getElementById('invoke-btn').disabled = true;
        document.getElementById('invoke-btn').innerHTML = `
            <svg class="animate-spin w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Invoking...
        `;

        var startTime = performance.now();

        try {
            var response = await fetch('/cds-services/' + selectedService.id, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(request)
            });

            var endTime = performance.now();
            document.getElementById('response-time').textContent = Math.round(endTime - startTime) + 'ms';

            var data = await response.json();
            lastResponse = data;

            document.getElementById('response-json').textContent = JSON.stringify(data, null, 2);
            document.getElementById('response-json').innerHTML = highlightJSON(JSON.stringify(data, null, 2));

            renderCards(data);

        } catch (e) {
            document.getElementById('response-json').textContent = 'Error: ' + e.message;
            document.getElementById('cards-placeholder').classList.remove('hidden');
            document.getElementById('cards-content').classList.add('hidden');
        } finally {
            document.getElementById('invoke-btn').disabled = false;
            document.getElementById('invoke-btn').innerHTML = `
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Invoke Service
            `;
        }
    }

    function renderCards(data) {
        var cards = data.cards || [];
        var placeholder = document.getElementById('cards-placeholder');
        var content = document.getElementById('cards-content');

        if (cards.length === 0) {
            placeholder.classList.remove('hidden');
            content.classList.add('hidden');
            placeholder.innerHTML = `
                <svg class="mx-auto h-12 w-12 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="mt-2 text-sm text-gray-500">No decision support cards returned</p>
            `;
            return;
        }

        placeholder.classList.add('hidden');
        content.classList.remove('hidden');

        var html = '';
        cards.forEach(function(card) {
            var indicatorColor = getIndicatorColor(card.indicator);
            html += `
                <div class="border rounded-lg overflow-hidden ${indicatorColor.border}">
                    <div class="px-4 py-3 ${indicatorColor.bg}">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                ${getIndicatorIcon(card.indicator)}
                            </div>
                            <div class="ml-3 flex-1">
                                <h3 class="text-sm font-medium ${indicatorColor.text}">${card.summary}</h3>
                                ${card.detail ? '<p class="mt-1 text-sm text-gray-600">' + card.detail + '</p>' : ''}
                            </div>
                        </div>
                    </div>
                    ${card.links && card.links.length > 0 ? renderLinks(card.links) : ''}
                    ${card.suggestions && card.suggestions.length > 0 ? renderSuggestions(card.suggestions) : ''}
                    ${card.source ? '<div class="px-4 py-2 bg-gray-50 text-xs text-gray-500">Source: ' + card.source.label + '</div>' : ''}
                </div>
            `;
        });
        content.innerHTML = html;
    }

    function getIndicatorColor(indicator) {
        switch (indicator) {
            case 'critical':
                return { bg: 'bg-red-50', border: 'border-red-200', text: 'text-red-800' };
            case 'warning':
                return { bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'text-yellow-800' };
            case 'info':
            default:
                return { bg: 'bg-blue-50', border: 'border-blue-200', text: 'text-blue-800' };
        }
    }

    function getIndicatorIcon(indicator) {
        switch (indicator) {
            case 'critical':
                return '<svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.28 7.22a.75.75 0 00-1.06 1.06L8.94 10l-1.72 1.72a.75.75 0 101.06 1.06L10 11.06l1.72 1.72a.75.75 0 101.06-1.06L11.06 10l1.72-1.72a.75.75 0 00-1.06-1.06L10 8.94 8.28 7.22z" clip-rule="evenodd" /></svg>';
            case 'warning':
                return '<svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.485 2.495c.673-1.167 2.357-1.167 3.03 0l6.28 10.875c.673 1.167-.17 2.625-1.516 2.625H3.72c-1.347 0-2.189-1.458-1.515-2.625L8.485 2.495zM10 5a.75.75 0 01.75.75v3.5a.75.75 0 01-1.5 0v-3.5A.75.75 0 0110 5zm0 9a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" /></svg>';
            default:
                return '<svg class="h-5 w-5 text-blue-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" /></svg>';
        }
    }

    function renderLinks(links) {
        var html = '<div class="px-4 py-2 border-t border-gray-200 space-y-1">';
        links.forEach(function(link) {
            html += '<a href="' + link.url + '" target="_blank" class="text-sm text-fhir-600 hover:text-fhir-700 flex items-center">';
            html += '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>';
            html += link.label;
            html += '</a>';
        });
        html += '</div>';
        return html;
    }

    function renderSuggestions(suggestions) {
        var html = '<div class="px-4 py-2 border-t border-gray-200 space-y-2">';
        html += '<p class="text-xs font-medium text-gray-500 uppercase">Suggestions</p>';
        suggestions.forEach(function(suggestion) {
            html += '<button class="w-full text-left px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 text-sm">';
            html += suggestion.label;
            html += '</button>';
        });
        html += '</div>';
        return html;
    }

    function showTab(tab) {
        document.getElementById('tab-request').classList.toggle('text-fhir-600', tab === 'request');
        document.getElementById('tab-request').classList.toggle('border-b-2', tab === 'request');
        document.getElementById('tab-request').classList.toggle('border-fhir-600', tab === 'request');
        document.getElementById('tab-request').classList.toggle('text-gray-500', tab !== 'request');

        document.getElementById('tab-response').classList.toggle('text-fhir-600', tab === 'response');
        document.getElementById('tab-response').classList.toggle('border-b-2', tab === 'response');
        document.getElementById('tab-response').classList.toggle('border-fhir-600', tab === 'response');
        document.getElementById('tab-response').classList.toggle('text-gray-500', tab !== 'response');

        document.getElementById('raw-request').classList.toggle('hidden', tab !== 'request');
        document.getElementById('raw-response').classList.toggle('hidden', tab !== 'response');
    }
</script>
{% endblock %}
